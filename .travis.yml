language: go

go:
  - "1.11"

before_install:
  - go get github.com/mattn/goveralls
  - go get github.com/fzipp/gocyclo
  - go get github.com/golang/dep/cmd/dep

before_script:
  - echo $TRAVIS_COMMIT
  - echo $TRAVIS_TAG
  - echo $TRAVIS_BRANCH
  - echo $TRAVIS_BUILD_NUMBER
  - echo $TRAVIS_REPO_SLUG
  - dep ensure

script:
  - go vet $(go list ./... | grep -v vendor)
  - go test -v -race  -coverprofile=coverage.out -coverpkg=./... $(go list ./... | grep -v vendor)
  - gocyclo -over 18 `find . -iname '*.go' | grep -v vendor | grep -v '_test.go'`
  - $GOPATH/bin/goveralls -coverprofile=coverage.out -service=travis-ci

before_deploy:
  - go get github.com/mitchellh/gox
  - gox -ldflags "-X github.com/target/flottbot/version.Version=${TRAVIS_TAG} -X github.com/target/flottbot/version.GitHash=${TRAVIS_COMMIT}" -os="linux darwin windows" -arch="amd64" -verbose ./...
  - ./tar-release.sh

deploy:
  provider: releases
  api_key:
    secure: oLU+dFjtuLK2OPGz9fTmuiSfinadk64+mo4gr/Et22354tsfB5mb30uaDPBWmO54fApbn08tBoT+RMW3bvKJ83q3Zwtf+V6xoEuMxfCBgVd4Es6pnMlv8tgZcY17Oe5/WBCaY7Qme3xi91u5OedwAU/U3ErxiaM6/jFwAzfw8/NGZDsM8wQoyFidc28vcEUilRJbYKZY6v2P84K35XNvo0xXNHrsMIbTcKH6SJZDxK8f/Dx4AutjsKseieWmzIEdQ+MTCgQ5jLU1PJEqsBBICet/IvNi6JLl4URpxWPwkw4M3nh9cwGOIVeJJyzi9U8pWeM1uA5bcNpqieg5Jvre4bIqpWGG2o8V7pN/1LEw3JQKVkBeHVhe/LUXwQZqnbGB6zIwqfz2n77RSPTf1JRQW0GgeM5sm5khiPfT2CSexCApcVrhLtLRBQNnYQZ6jJN3b2NMM1ZlKljHgJStSoX6mkvDuaLz+AN9U9YgK3uADoT5AT+PFEr8ktV+RZvE5zOwIVVIVWbnsvJRjNtUSYMxMSVdUOa9HgWsDn5QETYrP6q6DIi6mTqTcWtx+D5RU6UzRhjQ3V4C0EqqfE7A69UkwE/72drZMoLHaU/DnuuWQxOFCVBLQ7HtmgvXDvSQapWpEWQXbZ/mFbv80MDSfbyR9c6J4GIQRytaii79VZc4KLE=
  file_glob: true
  file: "*.tgz"
  skip_cleanup: true
  on:
    tags: true
